# 最初のデータ {#first-example}

データを分析するときには、大体次のような手順をとります。

1. 準備 Setup
2. データを取得 Import data
3. データ構造の確認 View data
4. 必要なら整形 Transform data
5. 視覚化 Visualize data
6. データを理解 Understand data

いろいろな視覚化を行い、そのデータからさまざまなことを理解する部分が中心だと思います。

## R のパッケージを活用

まず、この電子書籍の中心をなす、R を使った分析の一つの例を、見て行きたいと思います。一つ一つのコード（コンピュータ・プログラム）の説明は、後に回すとして、どのようなものなのか、雰囲気を味わっていただきたいと思います。

### 準備 Setup

まず、世界銀行（World Bank）の、世界開発指標（WDI: World Development Indicators）の一つの、GDP について、みてみましょう。GDP にも何種類かの尺度があるのですが、次のものを見てみます。

* NY.GDP.MKTP.CD: GDP (current US$)

NY.GDP.MKTP.CD は、データコードと言われるもので、世界開発指標（WDI）には、一つづつ決まっています。

これらの、WDI データコードの探し方なども、この書で少しずつ説明していきます。興味のある方は、[World Development Indicators](https://datatopics.worldbank.org/world-development-indicators/) のサイトの下にある、Data Themes（テーマ）からテーマを選択し、下にスクロールすると、Code をみることができます。ちなみに、ここで利用する NY.GDP.MKTP.CD: GDP (current US$) は、テーマの Economy（経済）を選択し、下にスクロールすると、一番上にあるものです。

英語は苦手という方は、ブラウザー（Edge, Google Chrome, Safari など）の翻訳機能を使うのも良いでしょう。ただ、そのページの対話型の機能（interactive function）を利用するときは、翻訳機能をOFF にする必要がある場合もありますので、覚えておいてください。

R には、WDI のデータを取得する R のツール（パッケージ）`WDI` がありますから、それを使います。また、データを取り扱うために基本的なツール（パッケージ）`tidyverse` を使います。これらの使い方などは、あとから、説明します。

```{r}
library(tidyverse)
library(WDI)
```

### データ取得 Import data

いよいよ、データを取得します。それを、`df_gdp` と名前をつけます。

```{r eval=FALSE}
df_gdp <- WDI(country = "all", 
              indicator = c(gdp = "NY.GDP.MKTP.CD"), 
              extra = TRUE)
```

```{r eval=TRUE, include=FALSE}
df_gdp <- read_csv("./data/df_wdi_gdp.csv")
```

### データ構造の確認

```{r}
head(df_gdp)
```

```{r}
df_gdp %>% glimpse()
```

概要 (`summary(df_gdp)`) からもある程度わかります。

```{r}
df_gdp %>% summary()
```

国のリストをみてみましょう。

```{r}
df_gdp %>% distinct(country) %>% pull()
```

### 必要なら整形 Transform data

変数が多いので、日本の部分だけみてみます。

```{r}
df_gdp %>% filter(country == "Japan")
```

たとえば、gdp のところに、4.940878e+12	とあるのは、Scientific notation と言われるもので、
$$4.940878 \times 10^{12} = 4,940,887,800,000$$
を意味します。最初に current US$ と、書いてあるように、現在の USD に換算した数値です。


### 視覚化 data visualization

日本のGDP の経年変化を折線グラフ（line graph）でみてみましょう。

```{r}
df_gdp %>% filter(country == "Japan") %>%
  ggplot(aes(x = year, y = gdp)) + geom_line()
```

### データを理解 Understand data

視覚化によって見えてくることがいくつもありますね。どんなことがわかりますか。気づいたことをあげてみましょう。

### さらなる分析

```{r}
df_gdp %>% drop_na(gdp) %>% ggplot(aes(x = year)) + geom_bar()
```

最新の2021年のデータはすべてあるわけではなさそうですが、大きい順に並べてみましょう。

```{r}
df_gdp %>% filter(year == 2021) %>% drop_na(gdp) %>% arrange(desc(gdp))
```

国以外のグループでも数値があるようですから、国だけを選んでみます。それには、region のところの Aggregates 以外を選択します。

```{r}
df_gdp %>% filter(year == 2021, region != "Aggregates") %>% 
  drop_na(gdp) %>% arrange(desc(gdp))
```

グラフではありませんが、これも一つの視覚化とも考えられないことはありません。

上位7カ国のGDP の推移を書いてみましょう。

```{r}
df_gdp %>% filter(iso2c %in% c("US", "CN", "JP", "DE", "IN", "GB", "FR")) %>%
  ggplot(aes(x = year, y = gdp, col = iso2c)) + geom_line()
```

ここからも幾つかのことがわかるかと思います。気づいたことを書いてみましょう。


```{r}
df_gdp %>% 
  filter(region != "Aggregates") %>% 
  drop_na(gdp) %>% 
  group_by(year) %>% 
  mutate(gdp_ratio = gdp/sum(gdp)) %>%
  ungroup() %>%
  filter(iso2c %in% c("US", "CN", "JP", "DE", "IN", "GB", "FR"))  %>%
  ggplot(aes(x = year, y = gdp_ratio, fill = iso2c)) + geom_area() + geom_line(col = "black", position = "stack", linewidth = 0.3) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))
```

これは、上から、iso2c の アルファベットの順番になっていますが、少し変更すると下のようになります。

```{r}
df_gdp %>% 
  filter(region != "Aggregates") %>% 
  drop_na(gdp) %>% 
  group_by(year) %>% 
  mutate(gdp_ratio = gdp/sum(gdp)) %>%
  ungroup() %>%
  filter(iso2c %in% c("US", "CN", "JP", "DE", "IN", "GB", "FR"))  %>%
  mutate(iso2co = factor(iso2c, levels = c("IN", "CN", "FR", "GB", "DE", "JP", "US"))) %>%
  ggplot(aes(x = year, y = gdp_ratio, fill = iso2co)) + geom_area() + geom_line(col = "black", position = "stack", linewidth = 0.3) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))
```

これらは、世界全体の GPT における割合です。主要国で、60%〜70% を占めていることがわかりますが、それぞれの国や、幾つかの国の影響力でしょうかも、ある程度みることができるように見えます。

いろいろなことが見えてくるように思います。

GDP が大きな国と、小さな国があるのはわかりますが、それは、どのように分布しているのでしょうか。

```{r}
df_gdp %>% drop_na(gdp) %>% 
  filter(year == 2021) %>%
  ggplot(aes(gdp)) + geom_histogram()
```

小さいところに集中していることがわかりますが、対数軸をとってみます。

```{r}
df_gdp %>% drop_na(gdp) %>% 
  filter(year == 2021) %>%
  ggplot(aes(gdp)) + geom_histogram() + scale_x_log10()
```

これは、2021年のデータですが、変化を見ることもできるでしょうか。

```{r}
df_gdp %>% drop_na(gdp) %>% 
  filter(year %in% c(1961, 1971, 1981, 1991, 2001, 2011, 2021)) %>%
  ggplot(aes(gdp, fill = factor(year))) + geom_density(alpha = 0.4) + scale_x_log10()
```

```{r}
df_gdp %>% drop_na(gdp) %>% 
  filter(year %in% c(1971, 1981, 1991, 2001, 2011, 2021)) %>%
  ggplot(aes(gdp, fill = factor(year))) + 
  geom_density() + scale_x_log10() + facet_wrap(~year)
```

いくつかのグループごとに分布をみてみることも可能です。それには、Boxplot が有効です。

```{r}
df_gdp %>% drop_na(gdp) %>% 
  filter(region != "Aggregates") %>%
  drop_na(region) %>%
  filter(year %in% c(2021)) %>%
  ggplot(aes(gdp, region, fill = region)) + 
  geom_boxplot() + scale_x_log10() + labs(y = "") + 
  theme(legend.position = "none")
```

```{r}
df_gdp %>% drop_na(gdp) %>% 
  filter(region != "Aggregates") %>%
  drop_na(income) %>%
  filter(year %in% c(2021)) %>%
  mutate(level = factor(income, c("High income", "Upper middle income", "Lower middle income", "Low income"))) %>%
  ggplot(aes(gdp, level, fill = income)) + 
  geom_boxplot() + scale_x_log10() + labs(y = "") + 
  theme(legend.position = "none")
```

これからも、いろいろなことがわかりますね。

地図で、国の income level をみてみましょう。

```{r cache=TRUE}
library(maps)
map_world <- map_data('world')
map_gdp <- map_world %>% 
  mutate(iso2c = iso.alpha(region, n=2)) %>% 
  mutate(map_region = region) %>% select(-region) %>% 
  left_join(df_gdp, by = "iso2c") 
head(map_gdp)
```

```{r cache = TRUE}
map_gdp %>% mutate(income_level = factor(income, levels = c("High income", "Upper middle income", "Lower middle income", "Low income", "Not classified", NA))) %>%
  ggplot() +
  geom_map(aes(long, lat, map_id = map_region, fill = income_level), map = map_world, col = "black", size = 0.1) 
```

```{r cache = TRUE}
map_gdp %>% mutate(income_level = factor(income, levels = c("High income", "Upper middle income", "Lower middle income", "Low income", "Not classified", NA))) %>%
  filter(year == 2021) %>%
  ggplot() +
  geom_map(aes(long, lat, map_id = map_region, fill = gdp), map = map_world, col = "black", size = 0.1) 
```

## 練習

それぞれのグラフから、わかったこと、問いなどを書いてください。

## コードの簡単な説明

### コードの取得、折れ線グラフ

いずれ、一つ一つのステップついて学びますが、まずは、データの取得と、７カ国の GDP の経年変化のグラフのコードの説明を、ChatGPT にしてもらいましょう。

> 質問：R のコードで、tidyverse と WDI を使って、GDP の分析をしますが、次のコードを、R の初心者にも理解できるように、ステップごとに説明してください。

```
df_gdp <- WDI(country = "all",
indicator = c(gdp = "NY.GDP.MKTP.CD"),
extra = TRUE)

df_gdp %>% filter(iso2c %in% c("US", "CN", "JP", "DE", "IN", "GB", "FR")) %>%
ggplot(aes(x = year, y = gdp, col = iso2c)) + geom_line()
```

**ChatGPT**

このコードは、世界銀行の経済指標データベースであるワールド・データ・アトラス（WDI）から、GDP（国内総生産）に関するデータを取得し、Tidyverseパッケージを使用して分析するものです。以下に、コードの各ステップを説明します。

以下のように、WDIパッケージをインストールしてロードします。このパッケージには、世界銀行のWDIデータベースにアクセスするために必要な機能が含まれています。

```
install.packages("WDI")
library(WDI)
```

WDI関数を使用して、国別のGDPデータを取得します。この関数の引数には、国、指標（ここではGDP）、および `extra = TRUE`を設定して、年度別のGDPデータも取得します。

```
df_gdp <- WDI(country = "all", 
              indicator = c(gdp = "NY.GDP.MKTP.CD"), 
              extra = TRUE)
```

取得したデータのうち、アメリカ、中国、日本、ドイツ、インド、イギリス、フランスの7か国のみを抽出します。iso2cは、2文字のISOコードで国を表しています。

```
df_gdp %>% filter(iso2c %in% c("US", "CN", "JP", "DE", "IN", "GB", "FR"))
```

ggplot関数を使用して、GDPの年次データをプロットします。x軸には年、y軸にはGDP、色には国を設定し、geom_line関数を使用して折れ線グラフを描画します。

```
df_gdp %>% filter(iso2c %in% c("US", "CN", "JP", "DE", "IN", "GB", "FR")) %>%
  ggplot(aes(x = year, y = gdp, col = iso2c)) + geom_line()
```

これにより、アメリカ、中国、日本、ドイツ、インド、イギリス、フランスのGDPの年次推移を比較する折れ線グラフが作成されます。

## まとめ

今回は、経済指標である、GDP を使いました。データサイエンスについて少しずつ、学んでいきたいと思います。

コードの説明をほとんどしていませんから、理解するのは難しいと思いますが、いくつかのことは、みてとることができるかなと思います。

* それほど、長くはない、コードで、データを見ていく。R は対話型（interactive）のプログラミング言語と言われています。

* コードに続けて、結果が表示されるので、コードと出力の対応が見やすい。また、コメントや説明も併記することができる。これは、RMarkdown という形式の中で、コードを書いていることによるものです。RMarkdown は、再現性（reproducibility）と、プログラム・コードの内容をコンピュータにわかるようにでなく、人間にもわかるように記述する（Literate Programming）を実現しています。

* 視覚化（Visualization）によって、わかることが色々とある。また、視覚化の方法もたくさんあり、いろいろな見方をすることで、データについての理解が深まっていく。

* 視覚化を通して、データを理解すること、問いを持ち、他の視覚化などを用いて、さらに、理解を深めることがたいせつ。

* 理解したことを元にして、さらに、そのデータ、または、他のデータを使って、新たな発見をしていく。

統計的な指標も用いますが、それらによって、新しい知識を生み出すとも表現しますが、そのような営み全体が、データサイエンスの核をなす部分だと思います。


