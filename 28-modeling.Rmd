# 数理モデル（Modeling） {#modeling}

## はじめに

データサイエンスにおいて、数理モデルを考えるとはどのようなことを意味するのでしょうか。簡単な表現は、データの（主要な）特徴の簡単な概要、またはそれを（いくつかの）数値で表現すること、と言ってもよいと思います。

![image](data/data-science.png)

その意味では、平均値や、中央値、四分位、最大値、最小値などの、代表値と言われるものも、そうですし、正規分布など、特定の分布に近い場合に、それを定める、平均値と、標準偏差の組みも、ひとつの数理モデルを与えると言えるでしょう。

ここでは、もう少し一般的な分布に関して使われる、数理モデルについて学びます。その中でも、基本的な、二変数に関する、線形モデルについてすこし、ていねいにみていきたいと思います。

簡単にいうと、X と Y という変数があったときに、X が増えると、Y も増えるとか、X が増加すると、Y は減少するという傾向をみたり、それが、どの程度、直線的に、増加、減少しているかを、$X = b + m\cdot X$ と、直線の方程式で近似し、それが、どの程度、実際のデータに近いかを表すというようなことです。

R では、$b$（Y 切片）は、intercept（切片）として表示され、$m$（直線の傾き）は、slope（傾き）として表示されます。

R を使って、モデルについて表示される、数値の意味も説明したいと思います。

数理モデルは、非常に多様なだけでなく（主要な）特徴は、分野ごとに必要度が異なることから、一般論として述べることには限界があります。H. ウィッカム（Hadley Wickham, el. al.）の R for Data Science の標準的な教科書でも、第一版には、基本的なことが含まれていましたが、[第二版](https://r4ds.hadley.nz) では、数理モデルは含まれていません。[Tidy Modeling with R](https://www.tmwr.org) を参照するようにとリンクがついています。

## 準備（Setup）

```{r}
library(tidyverse)
library(WDI)
library(readxl)
library(tidymodels)
```

Tidymodels を使いますが、これは、Tidyverse と同様に、一つのパッケージではなく、パッケージ群を表します。また、ここでは、ほんの一部しか使いませんが、一応、後々のために、インストールをし、使えるように `library(tidymodels)` で、読み込んでおいてください。

-   tidymodels: <https://www.tidymodels.org>

## 線形モデル入門

起動時に読み込まれる、datasets パッケージの、iris データを用いて、概要をみてみます。iris には、三種類の、あやめのデータが含まれていますが、ここでは、verginica と versicolor、すなわち、setosa 以外について扱います。

```{r}
df_iris0 <- as_tibble(datasets::iris) %>% filter(Species != "setosa")
```

二つの散布図を見てみます。一つ目は、X 軸が、花弁幅（はなびらのはば）、Y 軸が、花弁長（はなびらの長さ）、二つ目は、X 軸が、萼幅（がくのはば）、Y 軸が、花弁長（がくの長さ）を表した散布図です。

```{r}
df_iris0 %>% ggplot(aes(Petal.Width, Petal.Length)) + geom_point()
```

```{r}
df_iris0 %>% ggplot(aes(Sepal.Width, Sepal.Length)) + geom_point()
```

どちらも、幅（はなびらの幅や、がくの幅）が大きくなると、長さ（はなびらの長さや、がくの長さ）が大きくなる傾向があるように見えます。しかし、はなびらの散布図は、それが明らかにみてとれるだけでなく、ある直線にそって増加しているように見えます。がくの散布図では、その傾向が明らかではなく、直線にそって増加しているとまでは言えないように見えます。

すこし、違った、見方をする方もおられるかもしれません。それを、数値的に表現するのが、線形モデルを使った表現です。まずは、それぞれに、増加傾向をあらわす直線を描いてみましょう。これは、ある一定の方法で描いたものですが、いまは、大体、そんなものだと考えてくださって構いません。

```{r}
df_iris0 %>% ggplot(aes(Petal.Width, Petal.Length)) + geom_point() + geom_smooth(method="lm",formula=y~x, se=FALSE)
```

```{r}
df_iris0 %>% ggplot(aes(Sepal.Width, Sepal.Length)) + geom_point() + geom_smooth(method="lm",formula=y~x, se=FALSE)
```

たしかに、この二つの散布図と、直線を見ると、幅が増加すると長さも増加する傾向にあるようです。そこで、今度は、直線に近い、増加傾向にあると仮定して、適切な直線の方程式を求めてみます。それは、次のようにして求めることができます。

## Linear Model: Petal.Length \~ Petal.Width

```{r}
df_iris0 %>% lm(Petal.Length ~ Petal.Width, .)
```

## Formula: $\text{Petal.Length} = 2.224 + 1.600\cdot \text{Petal.Width}$

```{r echo=FALSE}
df_iris0 %>% ggplot(aes(Petal.Width, Petal.Length)) + geom_point() + geom_smooth(method="lm",formula=y~x, se=FALSE)
```

## Linear Model: Sepal.Length \~ Sepal.Width

```{r}
df_iris0 %>% lm(Sepal.Length ~ Sepal.Width, .)
```

## Formula: $\text{Sepal.Length} = 3.093 + 1.103\cdot \text{Sepal.Width}$

```{r echo=FALSE}
df_iris0 %>% ggplot(aes(Sepal.Width, Sepal.Length)) + geom_point() + geom_smooth(method="lm",formula=y~x, se=FALSE)
```

## Petal.Length \~ Petal.Width: R squared = 0.6779 - 68%

```{r}
df_iris0 %>% lm(Petal.Length ~ Petal.Width, .) %>% summary()
```

## Sepal.Length \~ Sepal.Width: R squared = 0.3068 - 31%

```{r}
df_iris0 %>% lm(Sepal.Length ~ Sepal.Width, .) %>% summary()
```

## Linear Model Basics: y \~ x

```         
lm(y~x, data)
```

```         
data %>% lm(y~x, .)
```

y-intercept, and slope: rate of increase or decrease

```         
summary(lm(y~x, data))
```

```         
data %>% lm(y~x, .) %>% summary()
```

(Multiple) R Squared: a value between 0 and 1, the model's strength. It is a measurement of the model quality. If the value is close to 1, the model quality is high. If it is close to 0, the model quality is low.

```{r echo=FALSE}
df_iris0 %>% ggplot(aes(Petal.Width, Petal.Length)) + geom_point() + geom_smooth(method="lm",formula=y~x, se=FALSE) + geom_hline(yintercept = mean(df_iris0$Petal.Length), col = "red")
```

```{r eval = FALSE}
df1 <- data.frame(x = c(1,2,3,4), y = c(1,0.5,2, 1.5))
ybar <- mean(df1$y)
mod1 <- lm(y~x, df1)
augment(mod1) %>% ggplot() + geom_point(aes(x,y)) + geom_smooth(aes(x,y), formula = y~x, method = "lm", se = FALSE) + geom_hline(yintercept = ybar, linetype="longdash", col = "red") + geom_point(aes(x, ybar), shape=4) + geom_point(aes(x, .fitted), shape =9, size=2) + geom_text(aes(x, ybar, label = paste0("(",x,",",1.25,")")), nudge_y = -0.1, col = "red") + geom_text(aes(x, .fitted, label = paste0("(",x,",",.fitted,")")), nudge_y = -0.1, col = "blue") + geom_text(aes(x, y, label = paste0("(",x,",",y,")")), nudge_y = -0.1) 
```

-   $(x_1, y_1)$, $(x_2,y_2)$, $(x_3, y_3)$, $(x_4, y_4)$: Data points
-   $\bar{y}$: mean of y = $(y_1 + y_2 + y_3 + y_4)/4$.
-   $\hat{y}_i$: prediction at $x_i$,
    -   $(x_1, \hat{y}_1)$, $(x_2, \hat{y}_2)$, $(x_3, \hat{y}_3)$, $(x_4, \hat{y}_4)$ are on the regression line.
-   $y_1-\hat{y}_1$, $y_2-\hat{y}_2$, $y_2-\hat{y}_2$, $y_2-\hat{y}_2$ are called residues.

```{r echo=FALSE}
df1 <- data.frame(x = c(1,2,3,4), y = c(1,0.5,2, 1.5))
ybar <- mean(df1$y)
mod1 <- lm(y~x, df1)
augment(mod1) %>% ggplot() + geom_point(aes(x,y)) + geom_smooth(aes(x,y), formula = y~x, method = "lm", se = FALSE) + geom_hline(yintercept = ybar, linetype="longdash", col = "red") + geom_point(aes(x, ybar), shape=4) + geom_point(aes(x, .fitted), shape =9, size=2) + geom_text(aes(x, ybar, label = paste0("(",x,",",1.25,")")), nudge_y = -0.1, col = "red") + geom_text(aes(x, .fitted, label = paste0("(",x,",",.fitted,")")), nudge_y = -0.1, col = "blue") + geom_text(aes(x, y, label = paste0("(",x,",",y,")")), nudge_y = -0.1) 
```

## R Squared

$$SS_{tot} = (1-1.25)^2 + (0.5-1.25)^2 + (2-1.25)^2 + (1.5-1.25)^2 = 1.25$$ $$SS_{res} = (1-0.8)^2 + (0.5-1.1)^2 + (2-1.4)^2 + (1.5-1.7)^2 = 0.8$$ $$R^2 = 1 - \frac{SS_{res}}{SS_{tot}} = 1- \frac{0.8}{1.25} = 0.36.$$

```{r}
summary(mod1)$r.squared
```

```{r}
mod1 %>% glance() %>% pull(r.squared)
```

```{r}
mod1 %>% glance() %>% select(`R Squared` = r.squared)
```

```{r}
mod1 %>% summary() %>% glimpse()
```

## Useful Mathematical Formula

-   Let $x = c(x_1, x_2, \ldots, x_n)$ be the independent variable, i.e., Sepal.L
-   Let $y = c(y_1, y_2, \ldots, y_n)$ be the dependent variable, i.e., Sepal.W
-   Let $\mbox{pred} = c(\hat{y}_1, \hat{y}_2, \ldots, \hat{y}_n)$ be the predicted values by linear regression.

$$
\begin{aligned}
\mbox{slope of the regression line}  &= \frac{cov(x,y)}{var(x)} = \frac{cor(x,y)\sqrt{var(y)}}{\sqrt{var(x)}}\\
\mbox{total sum of squares} &= SS_{tot} = \sum_{i}(y_i-mean(y))^2\\
\mbox{residual sum of squares} &= SS_{res} = \sum_{i}(y_i-\mbox{pred}_i)^2 = \sum_{i}(y_i-\hat{y}_i)^2\\
\mbox{R squared} = R^2 & = 1 - \frac{SS_{res}}{SS_{tot}} = cor(x,y)^2
\end{aligned}
$$

### Adjusted R Squared

$$\text{Adjusted }R^2 = 1- \frac{(1-R^2)(n-1)}{n-k-1}$$ $n$: number of observations, the number of rows

$k$: number of variables used for prediction

```{r}
df_iris0 %>% select(1:4) %>% cor()
```

```{r}
cormat <- df_iris0 %>% select(1:4) %>% cor()
cormat*cormat
```

```{r}
df_iris <- datasets::iris
```

```{r}
as_tibble(df_iris) %>% filter(Species == "setosa") %>% select(-5) %>% cor()
```

```{r}
as_tibble(df_iris) %>% filter(Species == "virginica") %>% select(-5) %>% cor()
```

```{r}
as_tibble(df_iris) %>% filter(Species == "versicolor") %>% select(-5) %>% cor()
```

```{r}
as_tibble(df_iris) %>% filter(Species == "virginica") %>% ggplot(aes(Sepal.Length, Petal.Length)) + geom_point() + geom_smooth(method = "lm", formula = y~x, se = FALSE)
```

```{r}
as_tibble(df_iris) %>% filter(Species == "virginica") %>% lm(Petal.Length ~ Sepal.Length, .) %>% glance() %>% pull(r.squared) %>% sqrt()
```

Correlations of the data suggest the possible strength of linear model y \~ x.

```{r}
df_iris %>% select(-5) %>% cor()
```

## 世界開発指標（WDI）からの例

-   SP.DYN.LE00.IN: Life expectancy at birth, total (years)

```{r cash = TRUE, eval=FALSE}
wdi_lifeExp <- WDI(indicator = c(lifeExp = "SP.DYN.LE00.IN"))
```

```{r include=FALSE, eval=FALSE}
write_csv(wdi_lifeExp, "./data/wdi_lifeExp.csv")
```

```{r echo=FALSE}
wdi_lifeExp <- read_csv("./data/wdi_lifeExp.csv")
```

```{r}
wdi_lifeExp %>% filter(country == "World") %>% drop_na(lifeExp) %>%
  ggplot(aes(year, lifeExp)) + geom_point() + geom_smooth(method = "lm", se = FALSE)
```

```{r}
wdi_lifeExp %>% lm(lifeExp ~ year, .) %>% summary()
```

$$lifeExp \sim -557.4 + 0.3123 \cdot year$$ Each year, life expectancy at birth increases approximately 0.3123 years. R-squared of this model is 0.2392, and the model explains 24%.

```{r}
wdi_lifeExp %>% filter(country == "World", year >= 1962, year <= 2019) %>% drop_na(lifeExp) %>% lm(lifeExp ~ year, .) %>% summary()
```

## BRICs

```{r}
mod_brics <- wdi_lifeExp %>% filter(country %in% c("Brazil", "Russian Federation", "India", "China")) %>% drop_na(lifeExp) %>% lm(lifeExp ~ year, .) %>% summary()
mod_brics$r.squared
```

```{r eval=FALSE}
wdi_lifeExp %>% filter(country %in% c("Brazil", "Russian Federation", "India", "China")) %>% drop_na(lifeExp) %>%
  ggplot(aes(year, lifeExp)) + geom_point() + geom_smooth(formula = y~x, method = "lm", se = FALSE)
```

```{r echo=FALSE}
wdi_lifeExp %>% filter(country %in% c("Brazil", "Russian Federation", "India", "China")) %>% drop_na(lifeExp) %>%
  ggplot(aes(year, lifeExp)) + geom_point() + geom_smooth(formula = y~x, method = "lm", se = FALSE)
```

```{r}
wdi_lifeExp %>% filter(country %in% c("Brazil", "Russian Federation", "India", "China")) %>% drop_na(lifeExp) %>%
  ggplot(aes(year, lifeExp, color = country)) + geom_point(aes(shape = country)) + geom_smooth(formula = y~x, method = "lm", se = FALSE)
```

Need to work

```{r eval=FALSE}
country_model <- function(df) {
  lm(lifeExp ~ year, data = df)
}

by_country <- wdi_lifeExp %>% filter(country %in% c("Brazil", "Russian Federation", "India", "China")) %>% drop_na(lifeExp) %>% group_by(country) %>% nest()

by_country <- by_country %>% 
  mutate(model = map(data, country_model))

by_country %>% 
  mutate(tidy = map(model, broom::tidy)) %>% 
  unnest(tidy)

by_country %>% 
  mutate(glance = map(model, broom::glance)) %>% 
  unnest(glance)
```

## Government Expenditure, (% of GDP)

```{r}
wdi_cache <- read_rds("./data/wdi_cache.RData")
```

```{r}
WDIsearch("expenditure", "name", cache = wdi_cache) %>% 
  inner_join(WDIsearch("% of GDP", "name", cache = wdi_cache))
```

```{r}
wdi_cache$series %>% filter(grepl("expenditure", name), grepl("% of GDP", name))
```

-   NY.GDP.PCAP.KD: GDP per capita (constant 2015 US\$)

-   SP.DYN.LE00.IN: Life expectancy at birth, total (years)

-   SP.POP.TOTL: Population, total

-   GB.XPD.RSDV.GD.ZS: Research and development expenditure (% of GDP) - 2

-   MS.MIL.XPND.GD.ZS: Military expenditure (% of GDP) - 6

-   SE.XPD.TOTL.GD.ZS: Government expenditure on education, total (% of GDP)

```{r cash = TRUE, eval=FALSE}
wdi_world <- WDI(country = "all", indicator = c(gdpPcap = "NY.GDP.PCAP.KD", lifeExp = "SP.DYN.LE00.IN", pop = "SP.POP.TOTL", research = "GB.XPD.RSDV.GD.ZS", military = "MS.MIL.XPND.GD.ZS", education = "SE.XPD.TOTL.GD.ZS"), 1990, extra = TRUE, cache = wdi_cache)
```

```{r include=FALSE, eval=FALSE}
write_csv(wdi_world, "./data/wdi_world")
```

```{r echo=FALSE}
wdi_world <- read_csv("./data/wdi_world")
```

```{r}
wdi_world
```

SE.XPD.TOTL.GB.ZS: Government expenditure on education, total (% of government expenditure) SE.XPD.TOTL.GD.ZS: Government expenditure on education, total (% of GDP) SE.XPD.PRIM.PC.ZS: Government expenditure per student, primary (% of GDP per capita) MS.MIL.XPND.ZS: Military expenditure (% of general government expenditure) SE.XPD.TERT.ZS: Expenditure on tertiary education (% of government expenditure on education)

```{r}
mod_e <- lm(lifeExp ~ education, wdi_world); mod_e
```

```{r}
wdi_world %>% ggplot(aes(education, lifeExp)) + geom_point() + geom_smooth(formula = y ~ x, method = "lm", se=FALSE)
```

```{r}
wdi_world %>% filter(income != "Aggregates") %>% drop_na(education, lifeExp) %>% ggplot(aes(education, lifeExp)) + geom_point() + geom_smooth(formula = y ~ x, method = "lm", se=FALSE)
```

```{r}
wdi_world_el <- wdi_world %>% select(country, year, education, lifeExp, gdpPcap, pop, research, military, region, income) %>% filter(income != "Aggregates") %>% drop_na(education, lifeExp)
```

```{r}
wdi_world_el %>% ggplot(aes(education)) + geom_histogram()
```

```{r}
wdi_world_el %>% filter(year==2020) %>% ggplot(aes(x = income, y = education, fill = income)) + geom_boxplot()
```

```{r}
wdi_world_el %>% filter(year==2020) %>% arrange(desc(education))
```

```{r}
wdi_world_el %>% filter(year==2020) %>% arrange(desc(education))
```

```{r}
wdi_world_el %>% filter(year==2020) %>% lm(gdpPcap ~ education, .)
```

```{r}
wdi_world_el %>% filter(year==2020) %>% lm(gdpPcap ~ education, .) %>% glance()
```

```{r}
wdi_world_el %>% lm(lifeExp ~ education + research + military, .) %>% glance()
```

```{r}
wdi_world_el %>% lm(lifeExp ~ education + research + military, .) %>% tidy()
```

$$lifeExp \sim 70.22 + 0.08\cdot education + 3.84 \cdot research - 0.07 \cdot military$$

```{r}
wdi_world_el %>% lm(gdpPcap ~ education + research + military, .) %>% tidy()
```

```{r}
wdi_world_el %>% lm(gdpPcap ~ education + research + military, .) %>% glance()
```

$$gdpPcap \sim 1077 + 1024\cdot education + 12792 \cdot research - 967 \cdot military$$

```{r}
mod_r <- lm(lifeExp ~ research, wdi_world); mod_e
```

## 数理モデルに関する参考文献

-   Tidy Modeling with R：tidymodel パッケージ群の教科書
    -   <https://www.tmwr.org>
-   Tidymodels パッケージ群
    -   <https://www.tidymodels.org>
    -   broom: <https://cran.r-project.org/web/packages/broom/index.html>
    -   Introduction to broom: <https://cran.r-project.org/web/packages/broom/vignettes/broom.html>

### モデル概要に現れる数値について

-   r-statistics.co by Selva Prabhakaran:
    -   <http://r-statistics.co/Linear-Regression.html>
-   Meaning Behind Each Section of Summary()
    -   <https://www.learnbymarketing.com/tutorials/explaining-the-lm-summary-in-r/>
