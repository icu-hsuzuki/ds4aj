# 視覚化（Visualize） {#visualize}

## 基本的なこと

R では、追加パッケージを使わなくても、簡単に、グラフを描画できますが、質の高いグラフを作成するには、`ggplot2` パッケージを用いたものが標準となっています。`ggplot2` は、`tidyverse` パッケージの一部ですので、`tidyverse` パッケージをインストール、使えるように、`library(tidyverse)` として読み込んであれば、そのまま使うことができます。

サイト：<https://ggplot2.tidyverse.org> パッケージサイト：<https://CRAN.R-project.org/package=ggplot2>

### ggplot2 概要

> ggplot2 is a system for declaratively creating graphics, based on *The Grammar of Graphics*. You provide the data, tell ggplot2 how to map variables to aesthetics, what graphical primitives to use, and it takes care of the details.
>
> ggplot2は、グラフィックスの生成に関する「Grammar of Graphics（グラフィックスの文法）」に基づいて、一つ一つの要素を定めていくことによって、グラフを作成するシステムです。データを提供し、変数を視覚的要素にマッピングする方法や、どのようなグラフィカルな基本要素を使用するかをggplot2に伝えると、詳細な部分はggplot2 が処理してくれます。

### 基本的な例

#### `tidyverse` の読み込み

タイトルや、列名などにに日本語を使う場合があるときは、`install.packages('showtext')` で、`showtext` パッケージをインストールして、下のように設定してください。そうでない場合は、最初の行 `library(tidyverse)` だけで他は不要です。

```{r}
library(tidyverse)
library(showtext) 
showtext_auto()
```

#### 復習

Tidyverse の章で、[紹介した例](https://icu-hsuzuki.github.io/ds4aj/tidyverse.html#ggplot2-グラフの描画)の復習から始めましょう。

```{r}
df_iris <- datasets::iris
```

```{r}
df_iris |> ggplot(aes(Sepal.Width, Sepal.Length)) + geom_point()
```

さまざまな描画が可能ですが、一番、一般的な、散布図、`plot` に対応するものです。`ggplot` の中の、`aes` （aesthetic）の部分に、x 軸、y 軸に対応する変数（列名）を書きます。

| `<DATA> |> ggplot(aes(<変数 x の列名>, <変数 y の列名>)) + geom_point()`

もっと明示的に

| `<DATA> |> ggplot(aes(x = <変数 x の列名>, y = <変数 y の列名>)) + geom_point()`

さらには

| `<DATA> |> ggplot(mapping = aes(x = <変数 x の列名>, y = <変数 y の列名>)) + geom_point()`

パイプを使わず

| `ggplot(<DATA>, aes(x = <変数 x の列名>, y = <変数 y の列名>)) + geom_point()`

や、さらに、詳しく

| `ggplot(data = <DATA>, mapping = aes(x = <変数 x の列名>, y = <変数 y の列名>)) + geom_point()`

も可能です。

種類（Species）ごとに色を変える場合には、`color = Species` とします。

```{r}
df_iris |> ggplot(aes(Sepal.Width, Sepal.Length, color = Species)) +
  geom_point()
```

さらに、点の大きさを、Petal.Width によって変える場合には次のように、`size = Petal.Width` を加えます。

```{r}
df_iris |> 
  ggplot(aes(Sepal.Width, Sepal.Length, color = Species, 
             size = Petal.Width)) +
  geom_point()
```

ここでは、散布図でしたから、`geom_point()` を使いましたが、これを他のものに変えていくと、さまざまなグラフが描けるようになっています。

## 散布図（Scatter Plot）

散布図は、データの二つの変数（列） を x と y に対応させる、最も基本的なグラフです。最初に試すべきグラフだともいうことができます。`mapping =` は省略することができます。

```         
ggplot(data = <data>, aes(x = <column name for x>, y = <column name for y>)) +
  geom_point()
```

```         
ggplot(data = df_iris, aes(x = Sepal.Length, y = Sepal.Width)) +
  geom_point()
```

変形（Transform）のときにつかった、`iris` データを使います。

```{r message=FALSE, warning=FALSE, comment=FALSE}
ggplot(data = df_iris, aes(x = Sepal.Length, y = Sepal.Width)) +
  geom_point()
```

### ラベル [Labels](https://ggplot2.tidyverse.org/reference/labs.html)

グラフの表題や、x 軸、y 軸のラベルをつけるには `labs()` を使います。

```         
ggplot(data = <data>, aes(x = <column name for x>, y = <column name for y>)) +
  geom_point() +
  labs(title = "Title", x = "Label for x", y = "Label for y")
```

```{r}
ggplot(data = df_iris, aes(x = Sepal.Length, y = Sepal.Width)) +
  geom_point() + 
  labs(title = "Scatter Plot of Sepal Data of Iris", x = "Sepal Length", y = "Sepal Width")
```

```{r}
ggplot(data = df_iris, aes(x = Sepal.Length, y = Sepal.Width)) +
  geom_point() + 
  labs(title = "あやめの萼の長さと幅についての散布図", x = "萼の長さ", y = "萼の幅")
```

このように、日本語をタイトルや、ラベルに使うことも可能ですが、以後は、データに日本語が含まれていない場合には、そのまま表示します。

### 色付き [Colors](https://ggplot2.tidyverse.org/reference/aes_colour_fill_alpha.html)

菖蒲（iris）のデータは、Species 列に、三種類の菖蒲の名前が含まれていました。それぞれに、違う色で表示してみましょう。それには、x 軸、y 軸に対応する変数を指定したように、`color = Species` と指定します。

```{r}
ggplot(data = df_iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +
  geom_point()
```

### 形状 [Shapes](https://ggplot2.tidyverse.org/articles/ggplot2-specs.html)

色ではなく、形で Species を区別することも可能です。

```{r}
ggplot(data = df_iris, aes(x = Sepal.Length, y = Sepal.Width, shape = Species)) +
  geom_point()
```

色と、形、両方を同時に使うことも可能です。

```{r}
ggplot(data = df_iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species, shape = Species)) +
  geom_point()
```

## 箱ひげ図 [Boxplot](https://ggplot2.tidyverse.org/reference/geom_boxplot.html)

The boxplot compactly displays the distribution of a continuous variable.

箱ひげ図は、連続な値をとる変数の分布を簡潔な表示でみることができるグラフです。箱や、線の長さ、外れ値の表示なども、正確に決まっていますので、次のビデオをみてください。英語ですが、わかりやすく、まとまっていると思います。

<https://vimeo.com/222358034>

日本語では、下のサイトの箱ひげ図の項目を見ていただければと思います。外れ値についての説明もあります。

箱ひげ図と幹葉表示：<https://bellcurve.jp/statistics/course/5219.html>

Transcript ボタンから、スクリプトを表示することもできます。

例のように、それぞれのグループごとに箱ひげ図を表示することもできますが、その場合は、文字データや、離散的な数値データ（いくつかの飛び飛びの値をとる変数）を使います。x と y を入れ替えれば、横向きになります。

```{r}
ggplot(data = df_iris, aes(x = Species, y = Sepal.Length)) +
  geom_boxplot()
```

```{r}
ggplot(data = df_iris, aes(y = Species, x = Sepal.Length)) +
  geom_boxplot()
```

各、種類（Species）ごとに、Sepal.Width（萼（がく）幅）が、どのように分布しているかを示しています。真ん中の太い線が、中央値（median）、箱が、第一四分位（Q1）から第三四分位（Q3）、線と点で表される外れ値も、どのような基準か定められています。(IQR = Q3-Q1, 線は、Q3+1.5$\times$ IQR 以下に入っている実際の値までと、Q1-1.5 $\times$ IQR 以上に入っている実際の値まで。それらに入っていないものが外れ値)。

color を指定すると、枠に色がつき、fill を指定すると、箱の中が塗り潰されます。

```{r}
ggplot(data = df_iris, aes(x = Species, y = Sepal.Length, color = Species)) +
  geom_boxplot()
```

```{r}
ggplot(data = df_iris, aes(x = Species, y = Sepal.Length, fill = Species)) +
  geom_boxplot()
```

### ヒストグラム [Histogram](https://ggplot2.tidyverse.org/reference/geom_histogram.html)

Visualize the distribution of a single continuous variable by dividing the x axis into bins and counting the number of observations in each bin. Histograms (geom_histogram()) display the counts with bars; frequency polygons (`geom_freqpoly()`) display the counts with lines. Frequency polygons are more suitable when you want to compare the distribution across the levels of a categorical variable.

単一の連続変数の分布を可視化するために、x軸をビンに分割し、各ビン内の観測値の数を数えます。ヒストグラム（geom_histogram()）は、棒で数を表示します。一方、頻度多角形（geom_freqpoly()）は、数を線で表示します。頻度多角形は、カテゴリ変数のレベル間の分布を比較したい場合により適しています。

説明ビデオです。<https://vimeo.com/221607341>

```{r}
ggplot(data = df_iris, aes(x = Sepal.Length)) +
  geom_histogram()
```

枠（bins）を幾つに分けるか、または枠の幅を指定するようにとのメッセージが表示されます。

枠（bins）の数を変更するには `bins =` `<number>`　を使います。幅を指定するときは、`binwidth = <number>` とします。

最初の例では、枠の個数を（初期設定では30になっているものを）10個とし、二つ目の例では、幅を1にしています。

```{r}
ggplot(data = df_iris, aes(x = Sepal.Length)) +
  geom_histogram(bins = 10)
```

```{r}
ggplot(data = df_iris, aes(x = Sepal.Length)) +
  geom_histogram(binwidth = 1)
```

頻度多角形（geom_freqpoly()）を使うと以下のようになります。Species ごとに比べたり、色をつけたりもできます。

```{r}
ggplot(data = df_iris, aes(x = Sepal.Length)) +
  geom_freqpoly()
```

```{r}
ggplot(data = df_iris, aes(x = Sepal.Length, color = Species)) +
  geom_freqpoly(bins = 10)
```

滑らかな曲線にするときは、density plot を使います。alpha は透明度で 0 から 1 の値で指定します。数が小さい方が薄くなります。color で線の色もあわせて設定することも可能です。いろいろと試してみてください。

```{r}
ggplot(data = df_iris, aes(x = Sepal.Length, fill = Species)) +
  geom_density(alpha = 0.5)
```

### 線形モデル Data Modeling

回帰直線を加えたり、他の近似曲線を加えることも可能です。グラフとしても直感的理解を助けますが、統計的な扱いについては、Modeling で説明します。

```{r, message=FALSE, warning=FALSE}
ggplot(data = df_iris, aes(x = Sepal.Length, y = Sepal.Width)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)
```

```{r, message=FALSE, warning=FALSE}
ggplot(data = df_iris, aes(x = Sepal.Length, y = Sepal.Width)) +
  geom_point() +
  geom_smooth()
```

## 例から学ぶ ggplot2`,` I

#### mpg を使って

`ggplot2` に含まれている、`mpg`（Fuel economy data from 1999 to 2008 for 38 popular models of cars - 1999年から2008年の38の型式の車の年燃費）データを使って、簡単な、散布図と、箱ひげ図を描いてみます。`mpg` の変数などについては、Help で調べてください。

manufacturer は、メーカー名、model は、型式、disp は、排気量（単位：リットル）、year は年式、cyl は、気筒数、trans は、オートマかマニュアルか、drv は、f が前輪駆動、r は後輪駆動、4 は四輪駆動、cty は街中での燃費（１ガロンで何マイル走るか）、hwy は高速道路での燃費（１ガロンで何マイル走るか）、fl 燃料の種類、class タイプ

```{r}
df_mpg <- ggplot2::mpg
df_mpg
```

```{r}
glimpse(df_mpg)
```

```{r}
ggplot(data = df_mpg) + geom_point(mapping = aes(x = displ, y = hwy))
```

```{r}
ggplot(data = df_mpg) + geom_boxplot(mapping = aes(x = class, y = hwy))
```

1.  `data = df_mpg` でデータを指定します。

2.  どのようなグラフにするか、幾何関数（Geometric Function）を指定します。散布図では、`geom_pont()` 、箱ひげ図では、`geom_boxplot()` などです。

3.  x 軸、y 軸などに対応する変数の写像（mapping）を指定します。

    -   散布図では、`dspl` （displacemnt エンジンの排気量（単位 リットル））を x 軸に、`hwy` 高速道路で１ガロンで走れる距離（単位 マイル）を y 軸に割り当てています。

    -   箱ひげ図では、`class` 車の型式を、x 軸に、`hwy` 高速道路で１ガロンで走れる距離（単位 マイル）を y 軸に割り当てています。

記号的に書くと、下のようになっています。

`ggplot(data = <DATA>) + <GEOM_FUNCTION>(mapping = aes(<MAPPINGS>))`

## 例から学ぶ ggplot2`,` II

### df_wdi, df_wdi_extra

前の章の `Tidyverse` で読み込み、概観した、世界開発指標（World Development Indicators）のデータを使います。[参照：WDI のデータ](https://icu-hsuzuki.github.io/ds4aj/tidyverse.html#wdi-のデータ)

```{r}
library(tidyverse)
library(WDI)
```

WDI の使い方は、世界銀行の部分で紹介しますが、はじめてのデータサイエンスの例でも紹介したように、データコードを利用して、データを読み込みます。ここでは、出生時の平均寿命と、一人当たりの　GDP と、総人口のデータを使います。

-   SP.DYN.LE00.IN: Life expectancy at birth, total (years) 出生時の平均寿命
-   SP.POP.TOTL: Population, total 総人口
-   NY.GDP.PCAP.KD: GDP per capita (constant 2015 US\$) 一人当たりの　GDP

次のコードで読み込みます。

```{r eval=FALSE}
df_wdi <- WDI(
  country = "all", 
  indicator = c(lifeExp = "SP.DYN.LE00.IN", pop = "SP.POP.TOTL", 
                gdpPercap = "NY.GDP.PCAP.KD")
)
```

```{r echo=FALSE, eval=FALSE}
df_wdi <- WDI(
  country = "all", 
  indicator = c(lifeExp = "SP.DYN.LE00.IN", pop = "SP.POP.TOTL", 
                gdpPercap = "NY.GDP.PCAP.KD")
)
write_csv(df_wdi, "./data/wdi.csv")
```

```{r echo=FALSE, eval=TRUE}
df_wdi <- read_csv("./data/wdi.csv")
```

```{r eval=FALSE}
df_wdi_extra <- WDI(
  country = "all", 
  indicator = c(lifeExp = "SP.DYN.LE00.IN", pop = "SP.POP.TOTL", 
                gdpPercap = "NY.GDP.PCAP.KD"), 
  extra = TRUE
)
```

すこし、追加情報を付加したものも取得しておきます。

```{r eval=FALSE, echo=FALSE}
df_wdi_extra <- WDI(
  country = "all", 
  indicator = c(lifeExp = "SP.DYN.LE00.IN", pop = "SP.POP.TOTL", 
                gdpPercap = "NY.GDP.PCAP.KD"), 
  extra = TRUE
)
write_csv(df_wdi_extra, "./data/wdi_extra.csv")
```

```{r eval=TRUE, echo=FALSE}
df_wdi_extra <- read_csv("./data/wdi_extra.csv")
```

```{r}
df_wdi
```

### 棒グラフ（bar graph and column graph）

まずは、年ごと、指標（indicator）ごとに、どの程度データがあるか見てみましょう。

```{r}
df_wdi |> drop_na(lifeExp, pop, gdpPercap) |>
  ggplot() + geom_bar(aes(year))
```

最初に、三つの indicator が どれもが、NA でない行だけを選択していますから、三つの指標がすべて値がある、データを年ごとに数えてグラフにしたものが、上のものになっています。表にすると次のようになっています。

```{r}
df_wdi |> drop_na(lifeExp, pop, gdpPercap) |>
  group_by(year) |> summarize(n = n())
```

同じような棒グラフですが、それぞれの値をグラフにする場合には、`geom_col()` を使います。

```{r}
regions <- df_wdi_extra |> drop_na(region) |>
  filter(region != "Aggregates") |> distinct(region) |> pull()
regions
```

```{r}
df_wdi_extra |> filter(income == "Aggregates", year == 2020) |>
  filter(country %in% regions) |>
  ggplot(aes(y = country, x = lifeExp)) + geom_col()
```

```{r}
df_wdi_extra |> filter(income == "Aggregates", year == 2020) |>
  filter(country %in% regions) |>
  ggplot(aes(y = country, x = pop)) + geom_col()
```

```{r}
df_wdi_extra |> filter(income == "Aggregates", year == 2020) |>
  filter(country %in% regions) |>
  ggplot(aes(y = country, x = gdpPercap)) + geom_col()
```

```{r}
df_wdi_extra |> filter(income != "Aggregates", year == 2020) |>
  group_by(region) |>
  ggplot(aes(y = region, fill = income)) + geom_bar()
```

### 備考

最後のグラフを例にとって、いくつかのコメントをしておきます。

#### 概要

地域のリストを regions に入れてありますから、2020 年のデータを取り出し、その中で、それぞれの国ごとのデータではなく、集計してあるもの（Aggregates）を選択してあります。そして、地域ごとのグループ化します。Y 軸に、地域名を取って、`geom_bar()` ですから、データがいくつあるかで棒グラフにしています。そのときに、`fill = income` としていますから、収入レベルごとに、色を変えて塗りつぶし（fill）て、描いています。color は、枠に色をつけ、fill は、塗りつぶしです。

#### 縦か横か

棒が横に伸びていますが、縦にすることも可能です。それには、`y = region` と書いてあるものを、`x = region` とすればできます。

```{r}
df_wdi_extra |> filter(income != "Aggregates", year == 2020) |>
  group_by(region) |>
  ggplot(aes(x = region, fill = income)) + geom_bar()
```

#### 地域名

なぜ、横にしたか、見当がついたかと思います。縦にすると、地域名が長くて重なってしまうのですね。もちろん、それを、改善する手がいくつかあります。1つ目は、地域名を縦にしたり、角度を付ける方法。`theme` を使い、中に角度を書きます。実は、それだけだと、ちょっと重なってしまうので、hjust の変数で調節しています。垂直方向の調節は、vjust です。数はいろいろと変更してみてください。

```{r}
df_wdi_extra |> filter(income != "Aggregates", year == 2020) |>
  group_by(region) |>
  ggplot(aes(x = region, fill = income)) + geom_bar() + 
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```

もう一つは折り返す方法です。こちらの法が、良いかもしれません。

```{r}
df_wdi_extra |> filter(income != "Aggregates", year == 2020) |>
  group_by(region) |>
  ggplot(aes(x = region, fill = income)) + geom_bar() + 
  scale_x_discrete(labels = function(x) str_wrap(x, width = 8))
```

もし、fill の方の凡例（legend）も短くしたければ、次のようにします。width のあとの数字は、適切な数を選んでください。

```{r}
df_wdi_extra |> filter(income != "Aggregates", year == 2020) |>
  group_by(region) |>
  ggplot(aes(x = region, fill = income)) + geom_bar() + 
  scale_x_discrete(labels = function(x) str_wrap(x, width = 8)) +
  scale_fill_discrete(labels = function(x) str_wrap(x, width = 8)) 
```

### **折線グラフ（line graph）**

WDI は時系列データですから、折れ線グラフも使います。後ほど紹介しますが、

| `<DATA> |> ggplot(aes(year, lifeExp)) + geom_line()`

と言った感じです。

まずは、失敗例から。次のコードでグラフが描けるでしょうか。

```{r}
df_wdi |> ggplot(aes(year, lifeExp)) + geom_line()
```

何が起こっているかわかりますか。これは、鋸の刃グラフ（saw-tooth chart）と言われる標準的な失敗例です。

```{r}
ggplot(df_wdi, aes(x = year, y = lifeExp)) + geom_boxplot()
```

これも期待した箱ひげ図にはなっていません。年は、カテゴリーではなく、数値データですね。

```{r}
typeof(pull(df_wdi, year)) # same as typeof(df$year)
```

次のようにすると少しマシになります。

```{r}
ggplot(df_wdi, aes(y = lifeExp, group = year)) + geom_boxplot()
```

##### Box Plot

```{r}
ggplot(df_wdi, aes(x = as_factor(year), y = lifeExp)) + geom_boxplot()
```

とはいえ、数が多すぎますね。色もつけてみましょう。塗りつぶしは、fill 枠の線に色をつけるのは、color ですから、ここでは、fill を使います。

```{r}
df_wdi_extra |> filter(income != "Aggregates") |> 
  filter(year %in% c(1960, 1980, 2000, 2020)) |>
  ggplot(aes(x=as_factor(year), y = lifeExp, fill = income)) +
  geom_boxplot()
```

折線グラフの例としては次のようなものがあります。

```{r}
df_lifeExp <- df_wdi_extra |> filter(region != "Aggregates") |>  
  group_by(region, year) |>
  summarize(mean_lifeExp = mean(lifeExp), median_lifeExp = median(lifeExp), max_lifeExp = max(lifeExp), min_lifeExp = min(lifeExp), .groups = "keep")
```

```{r}
df_lifeExp %>% ggplot(aes(x = year, y = mean_lifeExp, color = region)) +
  geom_line()
```

```{r}
df_lifeExp %>% ggplot(aes(x = year, y = mean_lifeExp, color = region, linetype = region)) +
  geom_line()
```

```{r}
df_lifeExp %>% ggplot() +
  geom_line(aes(x = year, y = mean_lifeExp, color = region)) + 
  geom_line(aes(x = year, y = median_lifeExp, linetype = region))
```

## コメント

### 参考文献

-   Cheat Sheet in RStudio: <https://www.rstudio.com/resources/cheatsheets/>

    -   [RStudio IED](https://raw.githubusercontent.com/rstudio/cheatsheets/main/rstudio-ide.pdf)
    -   [Base R Cheat Sheet](https://github.com/rstudio/cheatsheets/raw/main/base-r.pdf)

-   'Quick R' by DataCamp: <https://www.statmethods.net/management>

-   [An Introduction to R](https://cran.rstudio.com)

## 練習

### Posit Primers <https://posit.cloud/learn/primers>

1.  The Basics -- [r4ds: Explore, I](https://r4ds.had.co.nz/explore-intro.html#explore-intro)

-   [Visualization Basics](https://rstudio.cloud/learn/primers/1.1)
-   [Programming Basics](https://rstudio.cloud/learn/primers/1.2)
